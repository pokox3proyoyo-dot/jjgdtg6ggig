<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S.H.A.C. - Secure Hax Anonymous Chat</title>
    <script src="https://unpkg.com/tweetnacl@1.0.3/nacl-fast.js"></script>
    <script src="https://unpkg.com/tweetnacl-util@0.15.1/nacl-util.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #121212;
            color: #E0E0E0;
        }

        #container {
            width: 100%;
            max-width: 600px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            background-color: #1E1E1E;
        }

        #chat-window {
            flex-grow: 1;
            padding: 10px;
            overflow-y: auto;
            border-bottom: 1px solid #333;
        }

        #input-area {
            display: flex;
            padding: 10px;
            background-color: #2D2D2D;
        }

        #message-input {
            flex-grow: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background-color: #3C3C3C;
            color: #E0E0E0;
            resize: none;
            outline: none;
            margin-right: 10px;
        }

        #send-button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            background-color: #5E5E5E;
            color: white;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #send-button:hover:not(:disabled) {
            background-color: #7A7A7A;
        }
        
        #send-button:disabled {
            background-color: #333;
            cursor: not-allowed;
        }

        /* –°–û–û–ë–©–ï–ù–ò–Ø */
        .msg-container {
            display: flex;
            margin-bottom: 10px;
            word-wrap: break-word;
            word-break: break-all;
        }

        .msg-peer {
            justify-content: flex-start;
        }
        
        .msg-peer .msg-bubble {
            background-color: #2A482E; /* –ó–µ–ª–µ–Ω—ã–π */
            color: #E0E0E0;
        }

        .msg-self {
            justify-content: flex-end;
        }
        
        .msg-self .msg-bubble {
            background-color: #3A3A5E; /* –°–∏–Ω–∏–π */
            color: #E0E0E0;
        }

        .msg-bubble {
            max-width: 70%;
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 14px;
            position: relative;
        }
        
        .msg-time {
            display: block;
            font-size: 10px;
            color: rgba(224, 224, 224, 0.6);
            margin-top: 2px;
            text-align: right;
        }

        /* –¢–û–°–¢–´ –ò –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø */
        #toast-container {
            position: fixed;
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
        }

        .toast {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            margin-top: 10px;
            text-align: center;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .toast.show {
            opacity: 1;
        }

        #status-bar {
            padding: 5px 10px;
            background-color: #2D2D2D;
            font-size: 12px;
            color: #9E9E9E;
            border-top: 1px solid #333;
            text-align: center;
        }

        /* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (—Å–∫—Ä—ã—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) */
        #settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        #settings-box {
            background-color: #1E1E1E;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
        }

        #settings-box label, #settings-box h2 {
            display: block;
            margin-top: 10px;
            margin-bottom: 5px;
            color: #E0E0E0;
        }

        #settings-box input, #settings-box button {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #3C3C3C;
            border-radius: 5px;
            background-color: #3C3C3C;
            color: #E0E0E0;
            box-sizing: border-box;
        }
        
        #settings-box textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #3C3C3C;
            border-radius: 5px;
            background-color: #3C3C3C;
            color: #E0E0E0;
            box-sizing: border-box;
            resize: vertical;
        }

        #settings-box button {
            background-color: #007BFF;
            cursor: pointer;
        }

        #settings-box button:hover {
            background-color: #0056b3;
        }
        
        .warning {
            color: #FF6347;
            font-weight: bold;
        }
        
        .info {
            color: #6495ED;
            font-size: 12px;
        }

    </style>
</head>
<body>

<div id="container">
    <div id="chat-window">
        </div>
    <div id="input-area">
        <textarea id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
        <button id="send-button" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
    <div id="status-bar">
        <span id="connection-status">
            üîí –û–∂–∏–¥–∞–Ω–∏–µ –∫–ª—é—á–µ–π...
        </span> 
        | 
        <span id="settings-link" style="cursor: pointer; text-decoration: underline;">
            [–ù–∞—Å—Ç—Ä–æ–π–∫–∏]
        </span>
    </div>
</div>

<div id="settings-overlay">
    <div id="settings-box">
        <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ S.H.A.C.</h2>
        
        <p class="warning">
            –ù–ï –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ –æ–∫–Ω–æ, –ø–æ–∫–∞ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∫–ª—é—á–∏! –ï—Å–ª–∏ –∑–∞–∫—Ä–æ–µ—Ç–µ, –∫–ª—é—á–∏ –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.
        </p>

        <label for="peer-pub-input">–ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ (Peer Public Key):</label>
        <textarea id="peer-pub-input"></textarea>
        <p class="info">
            –ü–æ–ª—É—á–∏—Ç–µ —ç—Ç–æ—Ç –∫–ª—é—á —É –≤–∞—à–µ–≥–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞.
        </p>

        <label for="my-priv-input">–í–∞—à –°–ï–ö–†–ï–¢–ù–´–ô –∫–ª—é—á (My Secret Key):</label>
        <textarea id="my-priv-input"></textarea>
        <p class="info">
            –í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ —Å–≤–æ–π –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á, –∫–æ—Ç–æ—Ä—ã–π –≤—ã –ø–æ–ª—É—á–∏–ª–∏ —Ä–∞–Ω–µ–µ. –ï—Å–ª–∏ –æ–Ω –ø—É—Å—Ç, —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –Ω–æ–≤—ã–π.
        </p>

        <label for="my-pub-display">–í–∞—à –ü–£–ë–õ–ò–ß–ù–´–ô –∫–ª—é—á (–¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É):</label>
        <textarea id="my-pub-display" readonly></textarea>
        <p class="info">
            –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç –∫–ª—é—á –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É.
        </p>

        <button id="generate-key-button">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—É—é –ø–∞—Ä—É –∫–ª—é—á–µ–π</button>
        <button id="save-settings-button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
</div>

<div id="toast-container"></div>

<script>
    // =================================================================
    // 1. –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ü–ï–†–ï–ú–ï–ù–ù–´–ï (–û–ë–ù–û–í–õ–ï–ù–û –ü–û–î GOOGLE APPS SCRIPT)
    // =================================================================
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxP15XqdsbgS6OSd76rSf8T0kg4SJ4z7fBwxiBNfGs7RIVWLowvQ6wx3bmwcugPR3Xs/exec'; 
    const SESSION_ID = 'secure_hax_chat_id_42'; // –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —á–∞—Ç–æ–≤ –≤ —Ç–∞–±–ª–∏—Ü–µ
    const POLLING_RATE = 5000; // –û–ø—Ä–æ—Å –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥ (–ù–∞–¥–µ–∂–Ω–æ –¥–ª—è Google Sheets)

    // –ö–ª—é—á–∏ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    let myKeyPair = null; // –ú–æ—è –ø–∞—Ä–∞ –∫–ª—é—á–µ–π (–ø—É–±–ª–∏—á–Ω—ã–π –∏ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π)
    let peerPubUint8 = null; // –ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ (–≤ –≤–∏–¥–µ Uint8Array)
    let pollingInterval = null; // –ò–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –æ–ø—Ä–æ—Å–∞ (Polling)
    
    // –î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö ID —Å–æ–æ–±—â–µ–Ω–∏–π (—á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å)
    const receivedMessageIds = new Set();
    
    // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
    const chatWindow = document.getElementById('chat-window');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const statusBar = document.getElementById('connection-status');
    const settingsOverlay = document.getElementById('settings-overlay');
    const peerPubInput = document.getElementById('peer-pub-input');
    const myPrivInput = document.getElementById('my-priv-input');
    const myPubDisplay = document.getElementById('my-pub-display');


    // =================================================================
    // 2. –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò (–ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—è, Base64)
    // =================================================================

    // –•–µ–ª–ø–µ—Ä—ã –¥–ª—è Base64 (–∏—Å–ø–æ–ª—å–∑—É—é—Ç nacl.util)
    function encodeB64(bytes) {
        return nacl.util.encodeBase64(bytes);
    }
    
    function decodeB64(str) {
        try {
            return nacl.util.decodeBase64(str);
        } catch (e) {
            console.error("Base64 Decode Error:", e);
            showToast('‚ùå –û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –∫–ª—é—á–∞ Base64. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–ª—é—á.', 3000);
            return null;
        }
    }

    // =================================================================
    // 3. –õ–û–ì–ò–ö–ê –ú–ï–°–°–ï–ù–î–ñ–ï–†–ê
    // =================================================================

    // –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –æ–∫–Ω–µ —á–∞—Ç–∞
    function displayMessengerMessage(text, type, timestamp = new Date()) {
        const msgContainer = document.createElement('div');
        msgContainer.className = `msg-container ${type}`;

        const msgBubble = document.createElement('div');
        msgBubble.className = 'msg-bubble';
        
        const timeFormatted = timestamp.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        
        msgBubble.innerHTML = `<span>${text}</span><span class="msg-time">${timeFormatted}</span>`;

        msgContainer.appendChild(msgBubble);
        chatWindow.appendChild(msgContainer);
        chatWindow.scrollTop = chatWindow.scrollHeight; // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (–∑–∞–ø—É—Å–∫) Polling
    function startPollingForMessages() {
        if (pollingInterval) return; // –£–∂–µ –∑–∞–ø—É—â–µ–Ω

        const poll = () => {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—é/–¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—é
            if (!myKeyPair || !peerPubUint8) {
                clearInterval(pollingInterval);
                pollingInterval = null;
                statusBar.textContent = 'üîí –û–∂–∏–¥–∞–Ω–∏–µ –∫–ª—é—á–µ–π...';
                return;
            }

            // –ó–∞–ø—Ä–æ—Å –Ω–∞ Google Apps Script
            fetch(`${APPS_SCRIPT_URL}?sessionId=${SESSION_ID}`) 
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Server returned error: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    statusBar.textContent = `‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ. ID: ${encodeB64(myKeyPair.publicKey).slice(0, 10)}`;
                    sendButton.disabled = false;

                    if (data.ok && data.messages.length > 0) {
                        const mySenderId = encodeB64(myKeyPair.publicKey).slice(0, 10);
                        
                        data.messages.forEach(msg => {
                            // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–æ –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ –ø–æ–ª—É—á–µ–Ω–æ
                            if (receivedMessageIds.has(msg.id)) {
                                return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —É–∂–µ –∏–∑–≤–µ—Å—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                            }
                            
                            // 2. –û—Ç–º–µ—á–∞–µ–º –µ–≥–æ –∫–∞–∫ –ø–æ–ª—É—á–µ–Ω–Ω–æ–µ
                            receivedMessageIds.add(msg.id); 

                            // 3. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º, –µ—Å–ª–∏ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –æ—Ç –Ω–∞—Å
                            // –°–æ–æ–±—â–µ–Ω–∏—è –æ—Ç —Å–µ–±—è –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º, —Ç–∞–∫ –∫–∞–∫ –º—ã –∏—Ö —É–∂–µ –ø–æ–∫–∞–∑–∞–ª–∏ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ.
                            if (msg.sender !== mySenderId) { 
                                receiveMessageFromServer(msg.encryptedMessage, msg.timestamp);
                            } 
                        });
                    }
                })
                .catch(error => {
                    console.error('Polling Error:', error);
                    statusBar.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏/–±—ç–∫–µ–Ω–¥–∞. –ü–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ 5—Å...';
                    sendButton.disabled = true;
                });
        };

        // –ó–∞–ø—É—Å–∫–∞–µ–º Polling –∏ –≤—ã–ø–æ–ª–Ω—è–µ–º –ø–µ—Ä–≤—ã–π –æ–ø—Ä–æ—Å
        pollingInterval = setInterval(poll, POLLING_RATE); 
        poll(); 
    }
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏ –¥–µ—à–∏—Ñ—Ä–æ–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–∞
    function receiveMessageFromServer(encryptedText, timestampString) {
        try {
            const encryptedBytes = decodeB64(encryptedText);
            if (!encryptedBytes) return;

            // –î–µ—à–∏—Ñ—Ä–æ–≤–∫–∞
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–æ–π –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∏ –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ (peerPubUint8)
            const decryptedBytes = nacl.box.open.easy(
                encryptedBytes, 
                peerPubUint8, 
                myKeyPair.secretKey 
            );

            if (!decryptedBytes) {
                // –ï—Å–ª–∏ –¥–µ—à–∏—Ñ—Ä–æ–≤–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å, —ç—Ç–æ –ª–∏–±–æ:
                // 1. –ù–∞–º –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –º—É—Å–æ—Ä.
                // 2. –û—à–∏–±–∫–∞ –≤ –Ω–∞—à–∏—Ö –∫–ª—é—á–∞—Ö (—á–∞—â–µ –≤—Å–µ–≥–æ)
                throw new Error("Decryption failed. Check keys.");
            }

            const decryptedText = nacl.util.encodeUTF8(decryptedBytes);
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç—Ä–æ–∫—É ISO –≤ –æ–±—ä–µ–∫—Ç Date
            const time = new Date(timestampString); 
            
            // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            displayMessengerMessage(decryptedText, 'msg-peer', time);
            showToast('üîì –ü–æ–ª—É—á–µ–Ω–æ –∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ!', 1500);

        } catch (e) {
            console.error("Decryption or processing error:", e);
            displayMessengerMessage(`[–û–®–ò–ë–ö–ê –î–ï–®–ò–§–†–û–í–ö–ò] –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–ª—é—á–∏.`, 'msg-peer');
            showToast('‚ùå –û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∫–∏! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–ª—é—á–∏.', 3000);
        }
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –∏ —à–∏—Ñ—Ä–æ–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    function sendMessengerMessage() {
        if (!myKeyPair || !peerPubUint8) {
            showToast('üîí –°–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –∫–ª—é—á–∏!', 2000);
            return;
        }

        const message = messageInput.value.trim();
        if (!message) return;

        messageInput.value = ''; // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª—è
        sendButton.disabled = true; // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –¥–æ –æ—Ç–≤–µ—Ç–∞

        const messageBytes = nacl.util.decodeUTF8(message);
        const nonce = nacl.randomBytes(nacl.box.nonceLength);

        // –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–æ–π –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∏ –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ (peerPubUint8)
        const encryptedBytes = nacl.box.easy(
            messageBytes, 
            nonce, 
            peerPubUint8, 
            myKeyPair.secretKey
        );

        // –û–±—ä–µ–¥–∏–Ω—è–µ–º nonce –∏ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        const fullEncryptedBytes = new Uint8Array(nonce.length + encryptedBytes.length);
        fullEncryptedBytes.set(nonce);
        fullEncryptedBytes.set(encryptedBytes, nonce.length);

        const encryptedText = encodeB64(fullEncryptedBytes);
        const mySenderId = encodeB64(myKeyPair.publicKey).slice(0, 10);
        const sendTimestamp = new Date();


        // 3. üöÄ –û–¢–ü–†–ê–í–ö–ê –ù–ê GOOGLE APPS SCRIPT
        fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'cors',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                sessionId: SESSION_ID,
                encryptedMessage: encryptedText,
                sender: mySenderId
            })
        })
        .then(response => response.json())
        .then(data => {
            sendButton.disabled = false;
            if (data.ok) {
                // –ï—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —É—Å–ø–µ—à–Ω–∞, –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                displayMessengerMessage(message, 'msg-self', sendTimestamp);
                showToast('üîë –°–æ–æ–±—â–µ–Ω–∏–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!', 1500);
            } else {
                displayMessengerMessage(`[–û–®–ò–ë–ö–ê –û–¢–ü–†–ê–í–ö–ò] ${data.description || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`, 'msg-self', sendTimestamp);
                showToast('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ!', 3000);
            }
        })
        .catch(error => {
            console.error('Send Error:', error);
            sendButton.disabled = false;
            displayMessengerMessage(`[–û–®–ò–ë–ö–ê –°–ï–¢–ò] –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å.`, 'msg-self', sendTimestamp);
            showToast('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.', 3000);
        });
    }

    // =================================================================
    // 4. –õ–û–ì–ò–ö–ê –ù–ê–°–¢–†–û–ï–ö (–ö–ª—é—á–∏)
    // =================================================================

    function loadKeysFromStorage() {
        const privKeyB64 = localStorage.getItem('my_private_key');
        const pubKeyB64 = localStorage.getItem('my_public_key');
        const peerPubB64 = localStorage.getItem('peer_public_key');
        
        if (privKeyB64 && pubKeyB64) {
            myKeyPair = {
                publicKey: decodeB64(pubKeyB64),
                secretKey: decodeB64(privKeyB64)
            };
            
            // –ï—Å–ª–∏ –∫–ª—é—á —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω, —Å—Ä–∞–∑—É –¥–µ–∫–æ–¥–∏—Ä—É–µ–º –µ–≥–æ
            if (peerPubB64) {
                peerPubUint8 = decodeB64(peerPubB64);
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Polling, –µ—Å–ª–∏ –∫–ª—é—á–∏ –µ—Å—Ç—å
            startPollingForMessages();
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
        myPrivInput.value = privKeyB64 || '';
        myPubDisplay.value = pubKeyB64 || '–ö–ª—é—á –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω.';
        peerPubInput.value = peerPubB64 || '';
        
        updateStatus();
    }

    function generateNewKeyPair() {
        const pair = nacl.box.keyPair();
        myKeyPair = pair;
        
        const pubB64 = encodeB64(pair.publicKey);
        const privB64 = encodeB64(pair.secretKey);
        
        myPubDisplay.value = pubB64;
        myPrivInput.value = privB64;
        
        showToast('üîë –ù–æ–≤–∞—è –ø–∞—Ä–∞ –∫–ª—é—á–µ–π —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞!', 2000);
    }
    
    function saveSettings() {
        const newPeerPubB64 = peerPubInput.value.trim();
        const newMyPrivB64 = myPrivInput.value.trim();

        // 1. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–≤–æ–∏—Ö –∫–ª—é—á–µ–π
        if (newMyPrivB64 && newMyPrivB64 !== localStorage.getItem('my_private_key')) {
             try {
                const secretKeyBytes = decodeB64(newMyPrivB64);
                // –ò–∑–≤–ª–µ–∫–∞–µ–º –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –∏–∑ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
                const validKeyPair = nacl.box.keyPair.fromSecretKey(secretKeyBytes);
                
                localStorage.setItem('my_private_key', newMyPrivB64);
                localStorage.setItem('my_public_key', encodeB64(validKeyPair.publicKey));
                myKeyPair = validKeyPair;
                myPubDisplay.value = encodeB64(validKeyPair.publicKey);
                showToast('‚úÖ –í–∞—à–∏ –∫–ª—é—á–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!', 1500);
            } catch (e) {
                showToast('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å–µ–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞!', 3000);
                return;
            }
        }
        
        // 2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–ª—é—á–∞ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
        if (newPeerPubB64) {
            const peerBytes = decodeB64(newPeerPubB64);
            if (peerBytes && peerBytes.length === nacl.box.publicKeyLength) {
                localStorage.setItem('peer_public_key', newPeerPubB64);
                peerPubUint8 = peerBytes;
                showToast('‚úÖ –ö–ª—é—á —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!', 1500);
            } else {
                 showToast('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞!', 3000);
                 return;
            }
        } else {
             localStorage.removeItem('peer_public_key');
             peerPubUint8 = null;
        }

        settingsOverlay.style.display = 'none';
        
        // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º Polling —Å –Ω–æ–≤—ã–º–∏ –∫–ª—é—á–∞–º–∏
        clearInterval(pollingInterval);
        pollingInterval = null;
        startPollingForMessages();
        updateStatus();
    }
    
    function updateStatus() {
        if (myKeyPair && peerPubUint8) {
            statusBar.textContent = `‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ. ID: ${encodeB64(myKeyPair.publicKey).slice(0, 10)}`;
            sendButton.disabled = false;
        } else if (myKeyPair) {
            statusBar.textContent = '‚ö†Ô∏è –ù–µ—Ç –∫–ª—é—á–∞ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞. –ß–∞—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.';
            sendButton.disabled = true;
        } else {
            statusBar.textContent = 'üîí –û–∂–∏–¥–∞–Ω–∏–µ –∫–ª—é—á–µ–π...';
            sendButton.disabled = true;
        }
    }


    // =================================================================
    // 5. UI –∏ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    // =================================================================

    function showToast(message, duration) {
        const toastContainer = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        toastContainer.appendChild(toast);

        setTimeout(() => {
            toast.classList.add('show');
        }, 10);

        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toastContainer.removeChild(toast), 500);
        }, duration);
    }


    // =================================================================
    // 6. –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô
    // =================================================================
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ Enter (–±–µ–∑ Shift)
    messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (!sendButton.disabled) {
                sendMessengerMessage();
            }
        }
    });

    sendButton.addEventListener('click', sendMessengerMessage);
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
    document.getElementById('settings-link').addEventListener('click', () => {
        settingsOverlay.style.display = 'flex';
    });
    
    document.getElementById('save-settings-button').addEventListener('click', saveSettings);
    document.getElementById('generate-key-button').addEventListener('click', generateNewKeyPair);
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–ª—é—á–µ–π –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    window.onload = loadKeysFromStorage;

</script>
</body>
</html>
